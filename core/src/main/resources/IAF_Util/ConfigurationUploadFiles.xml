<module>	
	<adapter name="UploadFiles" description="Upload files to server" active="${uploadFiles.active}">	
		<receiver name="UploadFiles">
			<listener name="UploadFiles"
				className="nl.nn.adapterframework.http.rest.ApiListener"
				uriPattern="upload" 
				method="POST"
				multipartBodyName="destination"/>
		</receiver>

		<pipeline firstPipe="switchCleanFilesystem">	
			<exits>
				<exit state="success" path="EXIT" />
			</exits>
			
			<pipe name="switchCleanFilesystem" 
				className="nl.nn.adapterframework.pipes.XmlSwitch"
				sessionKey="cleanFilesystem" 
				notFoundForwardName="uploadFiles">
				<forward name="clean" path="deleteFilesystem" />
			</pipe>
			
			<pipe name="deleteFilesystem"
				className="nl.nn.adapterframework.pipes.CleanupOldFilesPipe"
				filePatternSessionKey="destination" 
				subdirectories="true"
				deleteEmptySubdirectories="true" 
				lastModifiedDelta="-1">
				<forward name="success" path="uploadFiles" />
			</pipe>
			
			<pipe name="uploadFiles"
				className="nl.nn.adapterframework.pipes.ForEachChildElementPipe"
				getInputFromSessionKey="multipartAttachments"
				elementXPathExpression="/parts/part[@type='file']">			
				<sender className="nl.nn.adapterframework.senders.IbisLocalSender"
					javaListener="UploadFiles_Child"/>
				<param name="unzipFile" sessionKey="ifUnzipFile"/>
				<param name="file" sessionKeyXPath="part/@name"/>
				<param name="destination" sessionKey="destination"/>
				<forward name="success" path="EXIT"/>
			</pipe>			
		</pipeline>		
	</adapter>
	
	<adapter name="UploadFiles_Child">
		<receiver name="UploadFiles_Child" >
			<listener name="UploadFiles_Child" className="nl.nn.adapterframework.receivers.JavaListener"/>
		</receiver>
		
		<pipeline firstPipe="isZipfile">
			<exits>
				<exit path="EXIT" state="success"/>
			</exits>
			
			<pipe name="isZipfile" 
				className="nl.nn.adapterframework.pipes.XmlSwitch"
				xpathExpression="contains($filename,'.zip')">
				<param name="filename" xpathExpression="part/@filename" />
				<forward name="true" path="switchUnzipFile" />
				<forward name="false" path="StoreFilenameInSessionkey" />
		    </pipe>
			
			<pipe name="switchUnzipFile" 
				className="nl.nn.adapterframework.pipes.XmlSwitch"
				sessionKey="unzipFile" 
				notFoundForwardName="StoreFilenameInSessionkey">
				<forward name="unzip" path="unzipFiles" />
			</pipe>
					    
		    <pipe name="unzipFiles" 
				className="nl.nn.adapterframework.pipes.UnzipPipe"
				getInputFromSessionKey="file"
				directorySessionKey="destination"
				createSubdirectories="true">
				<forward name="success" path="EXIT" />
			</pipe>
			
			<pipe name="StoreFilenameInSessionkey"
				className="nl.nn.adapterframework.pipes.XsltPipe"
				xpathExpression="concat($destination,$pathSeparator,$filename)"
				storeResultInSessionKey="filename">
				<param name="destination" sessionKey="destination"/>
				<param name="pathSeparator" value="${file.separator}"/>
				<param name="filename" xpathExpression="part/@filename"/>
				<forward name="success" path="writeFile"/>
			</pipe>
			
			<pipe name="writeFile"
				className="nl.nn.adapterframework.pipes.LocalFileSystemPipe"
				action="write">
                <param name="contents" sessionKey="file" />
                <param name="filename" sessionKey="filename" />
                <forward name="success" path="EXIT" />
            </pipe>
		</pipeline>
	</adapter>	
</module>